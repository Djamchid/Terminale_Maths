
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-translate="title">Module — Suites & Récurrence | Interactive Course</title>
  <style>
    :root{
      --primary:#2563eb;--primary-dark:#1e40af;--success:#10b981;--danger:#ef4444;
      --warning:#f59e0b;--muted:#6b7280;--bg:#f7fafc;--card:#ffffff;--border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);color:#111827;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;line-height:1.6}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header.site{background:var(--card);border-radius:14px;padding:18px 20px;box-shadow:0 8px 20px rgba(2,8,20,.05);margin-bottom:18px;position:relative}
    header.site h1{margin:0 0 6px 0;color:var(--primary-dark);font-size:1.6rem}
    header.site .sub{color:var(--muted);font-size:.98rem}
    /* Global controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:var(--primary);color:#fff;padding:.55rem .9rem;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary);border-color:var(--primary)}
    .btn.ghost{background:#fff;color:#111827;border-color:var(--border)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .select{padding:.5rem .7rem;border:1px solid var(--border);border-radius:10px;background:#fff}
    /* Progress */
    .progress{display:flex;align-items:center;gap:10px;margin-left:auto}
    .bar{flex:1;min-width:220px;height:10px;border-radius:999px;background:#e5e7eb;position:relative}
    .bar>span{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--primary),#60a5fa);border-radius:999px;transition:width .3s ease}
    .badge{font-size:.8rem;border-radius:999px;padding:.2rem .55rem;border:1px solid var(--border);background:#fff}
    main{display:grid;grid-template-columns:1fr;gap:16px}
    section.card{background:var(--card);border-radius:14px;padding:18px 20px;box-shadow:0 8px 20px rgba(2,8,20,.05)}
    section h2{margin:0 0 10px 0;color:var(--primary)}
    .note{background:#fffbeb;border-left:4px solid var(--warning);padding:12px;border-radius:10px;margin:10px 0}
    /* Exercises */
    .q{border:1px solid var(--border);border-radius:12px;padding:14px 14px;margin:14px 0;background:#fafafa}
    .q header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .q header .title{font-weight:700}
    .q .meta{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:.75rem;background:#eef2ff;color:#3730a3;border-radius:999px;padding:.2rem .5rem;border:1px solid #c7d2fe}
    .tag.warn{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .tag.ok{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
    .math{background:#f8fafc;border-left:3px solid var(--primary);padding:.6rem .8rem;border-radius:10px;margin:.4rem 0}
    .q .controls{gap:8px;justify-content:flex-start}
    .q .result{font-weight:700}
    .q .result.ok{color:var(--success)}
    .q .result.ko{color:var(--danger)}
    .q details{background:#fff;border:1px dashed var(--border);border-radius:10px;padding:10px;margin-top:8px}
    .q details>summary{cursor:pointer;font-weight:600}
    .answers{display:grid;gap:6px;margin:.4rem 0}
    label{display:block;margin:.2rem 0}
    input[type="text"],input[type="number"]{width:100%;max-width:420px;padding:.5rem .6rem;border:1px solid var(--border);border-radius:10px}
    .synth-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.progress{width:100%;margin-left:0}.synth-grid{grid-template-columns:1fr}}
    /* Accessibility */
    :focus-visible{outline:3px solid #60a5fa;outline-offset:2px}
    /* MathML display */
    math{font-family:STIX Math,Cambria Math,"Times New Roman",serif}
    math[display="block"]{display:block;margin:.6em 0}
  </style>
</head>
<body>
<div class="wrap" id="app">
  <header class="site">
    <h1 data-translate="h1">Suites & Récurrence — Cours interactif</h1>
    <p class="sub" data-translate="subtitle">Unité autonome : théorie concise, 12 exercices pratiques, synthèse finale.</p>
    <div class="controls" aria-label="Global controls">
      <button class="btn" id="checkAll" data-translate="checkAll">Tout valider</button>
      <button class="btn secondary" id="resetAll" data-translate="reset">Réinitialiser</button>
      <select id="lang" class="select" aria-label="Language">
        <option value="fr">FR</option>
        <option value="en">EN</option>
        <option value="zh">中文</option>
      </select>
      <div class="progress" style="min-width:280px">
        <span class="badge" id="progressText">0/12</span>
        <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="12" aria-valuenow="0" aria-label="Progression">
          <span id="barFill"></span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- THEORIE -->
    <section class="card" id="theory">
      <h2 data-translate="theory">Théorie</h2>
      <div class="note">
        <strong data-translate="tipTitle">Conseil</strong> — <span data-translate="tipBody">Précisez toujours l’initialisation et l’hérédité en récurrence. Pour les suites, identifiez le mode de génération, la monotonie et les bornes pour prouver la convergence.</span>
      </div>
      <p class="math">
        <!-- LaTeX inline & display demo -->
        \( \text{Si } (u_n) \text{ est décroissante et minorée, alors elle converge.} \)
      </p>
      <p class="math">
        \[ \text{Récurrence : } \begin{cases}
        \text{Initialisation : } \mathcal{P}(0) \ \text{vraie}\\
        \text{Hérédité : } \mathcal{P}(n)\Rightarrow \mathcal{P}(n+1)
        \end{cases}\Rightarrow \forall n,\ \mathcal{P}(n). \]
      </p>
      <p>
        <!-- MathML demo -->
        <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
          <mrow><mi>L</mi><mo>=</mo><mfrac><mrow><mi>L</mi><mo>+</mo><mn>1</mn></mrow><mn>2</mn></mfrac></mrow>
        </math>
      </p>
    </section>

    <!-- EXERCICES -->
    <section class="card" id="exercises">
      <h2 data-translate="exercises">Exercices</h2>

      <!-- 12 exercises across types: number, short, single, mc -->
      <!-- q1 -->
      <div class="q" data-id="q1" data-type="number" data-answer="1">
        <header>
          <span class="title">1. Limite d’une suite contractante</span>
          <span class="meta"><span class="tag">Récurrence</span><span class="tag ok" data-translate="easy">Facile</span></span>
        </header>
        <label data-translate="q1_lbl">Soit \(u_{n+1}=\dfrac{u_n+1}{2}\) avec \(u_0=2\). Limite \(L\) ?</label>
        <div class="answers"><input type="number" step="any" placeholder="L = ?" /></div>
        <div class="controls">
          <button class="btn ghost check" data-translate="check">Valider</button>
          <span class="result" data-result></span>
        </div>
        <details>
          <summary data-translate="hint">Indice</summary>
          <div>\(L=\frac{L+1}{2}\).</div>
        </details>
        <details>
          <summary data-translate="solution">Solution</summary>
          <div>\(2L=L+1\Rightarrow L=1\).</div>
        </details>
      </div>

      <!-- q2 -->
      <div class="q" data-id="q2" data-type="short" data-answers='["croissante"]'>
        <header>
          <span class="title">2. Variation</span>
          <span class="meta"><span class="tag">Suites</span><span class="tag" data-translate="medium">Moyen</span></span>
        </header>
        <label data-translate="q2_lbl">La suite \(v_{n+1}=\sqrt{2+v_n}\) avec \(v_0=1\) est … ?</label>
        <div class="answers"><input type="text" placeholder="croissante/décroissante" data-translate-placeholder="q2_ph" /></div>
        <div class="controls">
          <button class="btn ghost check" data-translate="check">Valider</button>
          <span class="result" data-result></span>
        </div>
        <details><summary data-translate="hint">Indice</summary><div>\(\sqrt{2+x}-x\) sur \(]0,2[\).</div></details>
        <details><summary data-translate="solution">Solution</summary><div>Elle est <strong>croissante</strong>.</div></details>
      </div>

      <!-- q3 -->
      <div class="q" data-id="q3" data-type="single" data-answer="b">
        <header>
          <span class="title">3. Point fixe</span>
          <span class="meta"><span class="tag">Limite</span><span class="tag" data-translate="medium">Moyen</span></span>
        </header>
        <label data-translate="q3_lbl">La limite \(L\) de \(x_{n+1}=\frac{3x_n+2}{x_n+4}\) vérifie :</label>
        <div class="answers">
          <label><input type="radio" name="q3" value="a"/> \(L=-2\)</label>
          <label><input type="radio" name="q3" value="b"/> \(L=1\)</label>
          <label><input type="radio" name="q3" value="c"/> \(L=2\)</label>
        </div>
        <div class="controls">
          <button class="btn ghost check" data-translate="check">Valider</button>
          <span class="result" data-result></span>
        </div>
        <details><summary data-translate="hint">Indice</summary><div>Résoudre \(L=\frac{3L+2}{L+4}\).</div></details>
        <details><summary data-translate="solution">Solution</summary><div>Équation \(L^2+L-2=0\Rightarrow L\in\{-2,1\}\). Avec \(x_n>0\), \(L=1\).</div></details>
      </div>

      <!-- q4 -->
      <div class="q" data-id="q4" data-type="mc" data-answer="a,c">
        <header>
          <span class="title">4. Choix multiple — Convergence</span>
          <span class="meta"><span class="tag">Convergence</span><span class="tag warn" data-translate="hard">Difficile</span></span>
        </header>
        <label data-translate="q4_lbl">Cochez les affirmations vraies pour une suite \((u_n)\) réelle :</label>
        <div class="answers">
          <label><input type="checkbox" value="a"/> Si \((u_n)\) est décroissante et minorée, alors elle converge.</label>
          <label><input type="checkbox" value="b"/> Si \((u_n)\) est croissante, elle diverge forcément.</label>
          <label><input type="checkbox" value="c"/> Si \((u_n)\) est bornée et monotone, elle converge.</label>
          <label><input type="checkbox" value="d"/> Toute suite bornée converge.</label>
        </div>
        <div class="controls">
          <button class="btn ghost check" data-translate="check">Valider</button>
          <span class="result" data-result></span>
        </div>
        <details><summary data-translate="hint">Indice</summary><div>Théorème des suites monotones.</div></details>
        <details><summary data-translate="solution">Solution</summary><div>Vraies : a, c.</div></details>
      </div>

      <!-- q5 -->
      <div class="q" data-id="q5" data-type="number" data-answer="0">
        <header><span class="title">5. Limite par récurrence</span><span class="meta"><span class="tag">Récurrence</span></span></header>
        <label data-translate="q5_lbl">Si \(u_0=0\) et \(u_{n+1}=\frac{u_n}{2}\), limite ?</label>
        <div class="answers"><input type="number" step="any" placeholder="L = ?" /></div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Suite géométrique de raison \(1/2\) : \(L=0\).</div></details>
      </div>

      <!-- q6 -->
      <div class="q" data-id="q6" data-type="short" data-answers='["arithmetique","arithmétique"]'>
        <header><span class="title">6. Type de suite</span><span class="meta"><span class="tag">Classification</span></span></header>
        <label data-translate="q6_lbl">Si \(u_{n+1}=u_n + 5\), le type est … ?</label>
        <div class="answers"><input type="text" placeholder="arithmétique, géométrique..." /></div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Suite <strong>arithmétique</strong> (raison 5).</div></details>
      </div>

      <!-- q7 -->
      <div class="q" data-id="q7" data-type="single" data-answer="c">
        <header><span class="title">7. Initialisation</span><span class="meta"><span class="tag">Récurrence</span></span></header>
        <label data-translate="q7_lbl">Dans une preuve par récurrence, l’étape qui n’en fait pas partie est :</label>
        <div class="answers">
          <label><input type="radio" name="q7" value="a"/> Initialisation</label>
          <label><input type="radio" name="q7" value="b"/> Hérédité</label>
          <label><input type="radio" name="q7" value="c"/> Conclusion par absurde</label>
        </div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Réponse c.</div></details>
      </div>

      <!-- q8 -->
      <div class="q" data-id="q8" data-type="mc" data-answer="b,d">
        <header><span class="title">8. Suites bornées</span><span class="meta"><span class="tag">Bornes</span></span></header>
        <label data-translate="q8_lbl">Cochez les propriétés vraies :</label>
        <div class="answers">
          <label><input type="checkbox" value="a"/> Toute suite croissante est majorée.</label>
          <label><input type="checkbox" value="b"/> Toute suite convergente est bornée.</label>
          <label><input type="checkbox" value="c"/> Toute suite bornée est monotone.</label>
          <label><input type="checkbox" value="d"/> Une suite monotone bornée converge.</label>
        </div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Vraies : b, d.</div></details>
      </div>

      <!-- q9 -->
      <div class="q" data-id="q9" data-type="number" data-answer="2">
        <header><span class="title">9. Limite imbriquée</span><span class="meta"><span class="tag">Limite</span></span></header>
        <label data-translate="q9_lbl">Pour \(v_{n+1}=\sqrt{2+v_n}\), \(v_0=1\), la limite vaut ?</label>
        <div class="answers"><input type="number" step="any" placeholder="L = ?" /></div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>\(L=\sqrt{2+L}\Rightarrow L=2\).</div></details>
      </div>

      <!-- q10 -->
      <div class="q" data-id="q10" data-type="short" data-answers='["geometrique","géométrique"]'>
        <header><span class="title">10. Type de suite (2)</span><span class="meta"><span class="tag">Classification</span></span></header>
        <label data-translate="q10_lbl">Si \(u_{n+1}=3u_n\), le type est … ?</label>
        <div class="answers"><input type="text" placeholder="arithmétique, géométrique..." /></div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Suite <strong>géométrique</strong> (raison 3).</div></details>
      </div>

      <!-- q11 -->
      <div class="q" data-id="q11" data-type="single" data-answer="a">
        <header><span class="title">11. Suites adjacentes</span><span class="meta"><span class="tag">Adjacentes</span></span></header>
        <label data-translate="q11_lbl">Deux suites adjacentes :</label>
        <div class="answers">
          <label><input type="radio" name="q11" value="a"/> Sont monotones de sens opposés et ont même limite.</label>
          <label><input type="radio" name="q11" value="b"/> Sont monotones de même sens et ont des limites différentes.</label>
          <label><input type="radio" name="q11" value="c"/> Ne convergent jamais.</label>
        </div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Réponse a.</div></details>
      </div>

      <!-- q12 -->
      <div class="q" data-id="q12" data-type="mc" data-answer="a,b,d">
        <header><span class="title">12. Récapitulatif</span><span class="meta"><span class="tag">Mix</span></span></header>
        <label data-translate="q12_lbl">Sélectionnez les affirmations vraies :</label>
        <div class="answers">
          <label><input type="checkbox" value="a"/> Une récurrence nécessite initialisation et hérédité.</label>
          <label><input type="checkbox" value="b"/> Une suite géométrique de raison \(r\) avec \(|r|<1\) converge.</label>
          <label><input type="checkbox" value="c"/> Une suite bornée est forcément convergente.</label>
          <label><input type="checkbox" value="d"/> Un point fixe vérifie \(f(L)=L\).</label>
        </div>
        <div class="controls"><button class="btn ghost check" data-translate="check">Valider</button><span class="result" data-result></span></div>
        <details><summary data-translate="solution">Solution</summary><div>Vraies : a, b, d.</div></details>
      </div>

    </section>

    <!-- SYNTHESE -->
    <section class="card" id="synthesis">
      <h2 data-translate="synthesis">Synthèse</h2>
      <div class="synth-grid">
        <div>
          <p><strong data-translate="score">Score</strong> : <span id="score">0/12</span></p>
          <p><strong data-translate="time">Temps estimé</strong> : <span>~60 min</span></p>
          <p><strong data-translate="advice">Conseil</strong> : <span data-translate="adviceBody">Reprenez les exercices en rouge et relisez les indices avant d’afficher la solution.</span></p>
        </div>
        <div>
          <ul id="todo"></ul>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Local MathJax bundle (same dir) -->
<script>
  // MathJax v3 config (no menu, TeX input, CHTML output)
  window.MathJax = {
    loader: {load: ['input/tex','output/chtml']},
    tex: {packages: {'[+]':['base','ams']}, inlineMath: [['\\(','\\)'],['$','$']], displayMath: [['\\[','\\]'],['$$','$$']], processEscapes: true},
    chtml: {matchFontHeight: true},
    options: {renderActions: {addMenu: []}} // disable context menu
  };
</script>
<script src="./mathjax_local.js"></script>

<script>
(function(){
  const STORAGE_KEY = 'interactive_course_progress_v1';
  const els = {
    q: Array.from(document.querySelectorAll('.q')),
    bar: document.getElementById('barFill'),
    barWrap: document.querySelector('.bar'),
    pText: document.getElementById('progressText'),
    score: document.getElementById('score'),
    todo: document.getElementById('todo'),
    checkAll: document.getElementById('checkAll'),
    resetAll: document.getElementById('resetAll'),
    lang: document.getElementById('lang'),
  };
  const t = {
    fr: {
      title:"Module — Suites & Récurrence | Cours interactif",
      h1:"Suites & Récurrence — Cours interactif",
      subtitle:"Unité autonome : théorie concise, 12 exercices pratiques, synthèse finale.",
      theory:"Théorie", exercises:"Exercices", synthesis:"Synthèse",
      checkAll:"Tout valider", reset:"Réinitialiser", check:"Valider",
      hint:"Indice", solution:"Solution", easy:"Facile", medium:"Moyen", hard:"Difficile",
      tipTitle:"Conseil", tipBody:"Précisez toujours l’initialisation et l’hérédité en récurrence. Pour les suites, identifiez le mode de génération, la monotonie et les bornes pour prouver la convergence.",
      score:"Score", time:"Temps estimé", advice:"Conseil", adviceBody:"Reprenez les exercices en rouge et relisez les indices avant d’afficher la solution.",
      q1_lbl:"Soit \(u_{n+1}=(u_n+1)/2\) avec \(u_0=2\). Limite \(L\) ?",
      q2_lbl:"La suite \(v_{n+1}=\sqrt{2+v_n}\) avec \(v_0=1\) est … ?",
      q2_ph:"croissante/décroissante",
      q3_lbl:"La limite \(L\) de \(x_{n+1}=(3x_n+2)/(x_n+4)\) vérifie :",
      q4_lbl:"Cochez les affirmations vraies pour une suite \((u_n)\) réelle :",
      q5_lbl:"Si \(u_0=0\) et \(u_{n+1}=u_n/2\), limite ?",
      q6_lbl:"Si \(u_{n+1}=u_n + 5\), le type est … ?",
      q7_lbl:"Dans une preuve par récurrence, l’étape qui n’en fait pas partie est :",
      q8_lbl:"Cochez les propriétés vraies :",
      q9_lbl:"Pour \(v_{n+1}=\sqrt{2+v_n}\), \(v_0=1\), la limite vaut ?",
      q10_lbl:"Si \(u_{n+1}=3u_n\), le type est … ?",
      q11_lbl:"Deux suites adjacentes :",
      q12_lbl:"Sélectionnez les affirmations vraies :",
      correct:"✅ Correct", wrong:"❌ À revoir"
    },
    en: {
      title:"Module — Sequences & Induction | Interactive Course",
      h1:"Sequences & Induction — Interactive Course",
      subtitle:"Self‑contained unit: concise theory, 12 practice exercises, final summary.",
      theory:"Theory", exercises:"Exercises", synthesis:"Summary",
      checkAll:"Validate all", reset:"Reset", check:"Check",
      hint:"Hint", solution:"Solution", easy:"Easy", medium:"Medium", hard:"Hard",
      tipTitle:"Tip", tipBody:"Always state base case and inductive step. For sequences, identify generation rule, monotonicity and bounds to prove convergence.",
      score:"Score", time:"Estimated time", advice:"Advice", adviceBody:"Retry items marked in red and read the hints before showing the solution.",
      q1_lbl:"Let \(u_{n+1}=(u_n+1)/2\) with \(u_0=2\). What is the limit \(L\)?",
      q2_lbl:"The sequence \(v_{n+1}=\sqrt{2+v_n}\) with \(v_0=1\) is … ?",
      q2_ph:"increasing/decreasing",
      q3_lbl:"The limit \(L\) of \(x_{n+1}=(3x_n+2)/(x_n+4)\) satisfies:",
      q4_lbl:"Tick the true statements for a real sequence \((u_n)\):",
      q5_lbl:"If \(u_0=0\) and \(u_{n+1}=u_n/2\), the limit is?",
      q6_lbl:"If \(u_{n+1}=u_n + 5\), the type is … ?",
      q7_lbl:"In an induction proof, which is NOT a step:",
      q8_lbl:"Tick the true properties:",
      q9_lbl:"For \(v_{n+1}=\sqrt{2+v_n}\), \(v_0=1\), the limit equals?",
      q10_lbl:"If \(u_{n+1}=3u_n\), the type is … ?",
      q11_lbl:"Two adjacent sequences:",
      q12_lbl:"Select the true statements:",
      correct:"✅ Correct", wrong:"❌ Try again"
    },
    zh: {
      title:"模块 — 数列与数学归纳法 | 交互课程",
      h1:"数列与归纳法 — 交互课程",
      subtitle:"独立单文件：简明理论，12 个练习，结尾总结。",
      theory:"理论", exercises:"练习", synthesis:"总结",
      checkAll:"全部验证", reset:"重置", check:"验证",
      hint:"提示", solution:"解答", easy:"简单", medium:"中等", hard:"困难",
      tipTitle:"提示", tipBody:"归纳法需写明基例与递推。研究数列时，识别生成方式、单调性与有界性以证明收敛。",
      score:"得分", time:"预计时间", advice:"建议", adviceBody:"优先重做红色题目，先读提示再展开解答。",
      q1_lbl:"设 \(u_{n+1}=(u_n+1)/2\)，\(u_0=2\)。极限 \(L\) 为？",
      q2_lbl:"数列 \(v_{n+1}=\sqrt{2+v_n}\)，\(v_0=1\)，其单调性为？",
      q2_ph:"递增/递减",
      q3_lbl:"\(x_{n+1}=(3x_n+2)/(x_n+4)\) 的极限 \(L\) 满足：",
      q4_lbl:"关于实数列 \((u_n)\) 的正确命题是：",
      q5_lbl:"若 \(u_0=0\) 且 \(u_{n+1}=u_n/2\)，极限为？",
      q6_lbl:"若 \(u_{n+1}=u_n + 5\)，类型为？",
      q7_lbl:"在归纳证明中，不属于步骤的是：",
      q8_lbl:"勾选正确性质：",
      q9_lbl:"对 \(v_{n+1}=\sqrt{2+v_n}\)，\(v_0=1\)，极限等于？",
      q10_lbl:"若 \(u_{n+1}=3u_n\)，类型为？",
      q11_lbl:"两条相邻数列：",
      q12_lbl:"选择为真的断言：",
      correct:"✅ 正确", wrong:"❌ 需要再试"
    }
  };

  // --- i18n helpers ---
  function setLang(lang){
    const dict = t[lang] || t.fr;
    document.documentElement.lang = (lang==='zh'?'zh':lang);
    // translate text nodes and placeholders
    document.querySelectorAll('[data-translate]').forEach(el=>{
      const key = el.getAttribute('data-translate');
      if(dict[key]) el.textContent = dict[key];
    });
    document.querySelectorAll('[data-translate-placeholder]').forEach(el=>{
      const key = el.getAttribute('data-translate-placeholder');
      if(dict[key]) el.setAttribute('placeholder', dict[key]);
    });
    document.title = dict.title;
    localStorage.setItem('course_lang', lang);
    // re-typeset visible math after language change
    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise([document.querySelector('.wrap')]);
    }
  }

  // --- normalization helpers for 'short' ---
  const norm = s => s.toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // strip accents
    .replace(/’/g,"'").replace(/\s+/g,' ').trim();

  // --- persistence ---
  const store = {
    load(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); } catch { return {}; }
    },
    save(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); },
    clear(){ localStorage.removeItem(STORAGE_KEY); }
  };
  let state = store.load();

  // --- validation per type ---
  function checkOne(qEl){
    const id = qEl.dataset.id;
    const type = qEl.dataset.type;
    const badge = qEl.querySelector('[data-result]');
    let correct = false, inputData = null;

    if(type==='number'){
      const val = Number(qEl.querySelector('input[type="number"]').value);
      const ans = Number(qEl.dataset.answer);
      inputData = String(val);
      correct = (val===ans);
    }else if(type==='short'){
      const val = qEl.querySelector('input[type="text"]').value;
      inputData = val;
      let answers = [];
      try { answers = JSON.parse(qEl.dataset.answers); } catch { answers = []; }
      correct = answers.map(norm).includes(norm(val));
    }else if(type==='single'){
      const checked = qEl.querySelector('input[type="radio"]:checked');
      inputData = checked ? checked.value : '';
      correct = inputData === qEl.dataset.answer;
    }else if(type==='mc'){
      const selected = Array.from(qEl.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value).sort();
      inputData = selected;
      const want = (qEl.dataset.answer||'').split(',').map(s=>s.trim()).filter(Boolean).sort();
      // set equality
      correct = (selected.length===want.length) && selected.every((v,i)=>v===want[i]);
    }

    // feedback
    badge.textContent = correct ? (tr('correct')) : (tr('wrong'));
    badge.className = 'result ' + (correct ? 'ok':'ko');

    // persist
    state[id] = { input: inputData, correct };
    store.save(state);

    updateProgress();
    updateSynthesis();
  }

  function tr(key){
    const dict = t[els.lang.value] || t.fr;
    return dict[key] || key;
  }

  function restore(){
    // restore language
    const lang = localStorage.getItem('course_lang') || 'fr';
    els.lang.value = lang;
    setLang(lang);

    // restore answers
    for(const qEl of els.q){
      const st = state[qEl.dataset.id];
      if(!st) continue;
      if(qEl.dataset.type==='number' && st.input!=null){
        qEl.querySelector('input[type="number"]').value = st.input;
      }else if(qEl.dataset.type==='short' && st.input!=null){
        qEl.querySelector('input[type="text"]').value = st.input;
      }else if(qEl.dataset.type==='single' && st.input){
        const r = qEl.querySelector('input[type="radio"][value="'+st.input+'"]');
        if(r) r.checked = true;
      }else if(qEl.dataset.type==='mc' && Array.isArray(st.input)){
        for(const v of st.input){
          const c = qEl.querySelector('input[type="checkbox"][value="'+v+'"]');
          if(c) c.checked = true;
        }
      }
      // show previous result
      if(typeof st.correct === 'boolean'){
        const badge = qEl.querySelector('[data-result]');
        badge.textContent = st.correct ? tr('correct') : tr('wrong');
        badge.className = 'result ' + (st.correct ? 'ok':'ko');
      }
    }
    updateProgress();
    updateSynthesis();
  }

  function updateProgress(){
    const total = els.q.length;
    const good = els.q.filter(q => (state[q.dataset.id] && state[q.dataset.id].correct)).length;
    const pct = Math.round(100*good/total);
    els.pText.textContent = good + '/' + total;
    els.bar.style.width = pct + '%';
    els.barWrap.setAttribute('aria-valuenow', String(good));
    els.score.textContent = els.pText.textContent;
  }

  function updateSynthesis(){
    els.todo.innerHTML = '';
    for(const qEl of els.q){
      const id = qEl.dataset.id;
      const title = qEl.querySelector('.title')?.textContent || id;
      const st = state[id];
      if(!st || !st.correct){
        const li = document.createElement('li');
        li.textContent = title + ' — ' + tr('wrong');
        els.todo.appendChild(li);
      }
    }
  }

  // event wiring
  els.q.forEach(qEl => {
    qEl.querySelectorAll('.check').forEach(btn => btn.addEventListener('click', () => {
      checkOne(qEl);
      // typeset math possibly revealed inside details
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([qEl]);
      }
    }));
    // re-typeset on details toggle
    qEl.querySelectorAll('details').forEach(d => {
      d.addEventListener('toggle', () => {
        if (d.open && window.MathJax && MathJax.typesetPromise) {
          MathJax.typesetPromise([d]);
        }
      });
    });
  });

  els.checkAll.addEventListener('click', () => { els.q.forEach(checkOne); });
  els.resetAll.addEventListener('click', () => {
    store.clear(); state = {}; document.querySelectorAll('input').forEach(i => {
      if(i.type==='checkbox' || i.type==='radio'){ i.checked=false; } else { i.value=''; }
    });
    document.querySelectorAll('[data-result]').forEach(b => { b.textContent=''; b.className='result'; });
    updateProgress(); updateSynthesis();
  });
  els.lang.addEventListener('change', () => setLang(els.lang.value));

  // init
  document.addEventListener('DOMContentLoaded', restore);
})();
</script>
</body>
</html>
